{% extends "layout.html" %}

{% block title %}
Chat {{other_user.id}}
{% endblock  %}

{% block content %}

<!-- main navbar -->
{% include "components/navbar.html" with default_profile_picture=default_profile_picture %}

<!-- opposite user navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light px-4 py-2 border-bottom">
  <div class="container-fluid">
    <div class="d-flex align-items-center">
      <!-- User Info -->
        {% if request.user.userprofile.image %}
          <img src="{{ other_user.userprofile.image.url }}" alt="Profile" class="rounded-circle me-2" width="40" height="40">
        {% else %}
          <img src="{{default_profile_picture}}" alt="Profile" class="rounded-circle me-2" width="40" height="40">
        {% endif %}
        <span class="fw-bold">{{ other_user.get_full_name }}</span>
      </a>
    </div>
  </div>
</nav>

<!-- chat form -->
<div class="container py-4">
  <div class="mb-4" id="chat-messages">
    {% for msg in messages %}
      {% if msg.from_user == request.user %}
        <!-- Your message: aligned right -->
        <div class="d-flex justify-content-end mb-3" 
        id="msg-{{ msg.id }}"
        >
          <div class="text-white p-3 rounded" style="max-width: 75%; background-color: #256dd8ff;">
            <div class="message-div">{{ msg.message }}</div>
            <div class="text-end small mt-1">
              {{ msg.created_at|date:"M d, H:i" }}
              <span onclick="editMessage({{ msg.id }}, '{{ msg.message|escapejs }}')" class="text-white ms-2">Edit</span>
              <span onclick="deleteMessage({{ msg.id }})" class="text-white ms-2">Delete</span>
            </div>
          </div>
        </div>
      {% else %}
        <!-- Other user's message: aligned left -->
        <div class="d-flex justify-content-start mb-3" 
        id="msg-{{ msg.id }}"
        >
          <div class="text-dark p-3 rounded" style="max-width: 75%; background-color: #dfdfdfff;">
            <div class="message-div">
              {{ msg.message }}</div>
            <div class="text-muted small mt-1">{{ msg.created_at|date:"M d, H:i" }}</div>
          </div>
        </div>
      {% endif %}
    {% empty %}
      <p class="text-muted">No messages yet.</p>
    {% endfor %}
  </div>

  <!-- Message form -->
  <form method="post" id="chat-form">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Send</button>
  </form>

</div>

<script>
  const _url = 'ws://' + window.location.host + '/ws/chat/{{ other_user.id }}/'
  const socket = new WebSocket(_url);
  
  socket.onopen = function(e) {
      // console.log("WebSocket connected.");
  };
  
  socket.onerror = function(e) {
      // console.error("WebSocket error:", e);
  };

  const form = document.getElementById('chat-form');
  const input = document.getElementById('id_message');  // Django gives the input field id as `id_<field_name>`

  form.addEventListener('submit', function (e) {
    e.preventDefault();  // prevent normal POST submit

    const message = input.value.trim();
    if (message === '') return;
    const _data = {
      message: message,
      to_user_id: {{ other_user.id }},
      from_user_id: '{{ request.user.id }}',
      message_type: "message",
    }
    socket.send(JSON.stringify(_data));

    input.value = '';
  });

  socket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      // console.log("Message Received:", data);
      const message_type = data?.message_type

      if(message_type === "message"){
          const isOwn = data.from_user_id === {{ request.user.id }};
          const box = document.createElement('div');

          box.setAttribute('data-message-id', data.id);  // for editing later

          let _html = isOwn ? `
            <div class="d-flex justify-content-end mb-3" id="msg-${data.id}">
              <div class="text-white p-3 rounded" style="max-width: 75%; background-color: #256dd8ff;">
                <div class="message-div">${data.message}</div>
                <div class="text-end small mt-1">
                  ${data.time}
                    <span onclick="editMessage(${data.id}, '${data.message.replace(/'/g, "\\'")}')" class="text-white ms-2">Edit</span>
                    <span onclick="deleteMessage(${data.id})" class="text-white ms-2">Delete</span>
                </div>
              </div>
            </div>
          ` : `
            <div class="d-flex justify-content-start mb-3" id="msg-${data.id}">
              <div class="text-dark p-3 rounded" style="max-width: 75%; background-color: #dfdfdfff;">
                <div class="message-div"> ${data.message}</div>
                <div class="text-muted small mt-1">${data.time}</div>
              </div>
            </div>
          `

          box.innerHTML = _html
          document.getElementById('chat-messages').appendChild(box);
      }

      if (message_type === "delete") {
        const msgDiv = document.getElementById(`msg-${data.id}`);
        if (msgDiv) msgDiv.remove();
      }

      if (message_type === "edit") {
        const msgDiv = document.getElementById(`msg-${data.id}`);
        if (msgDiv) {
          const contentDiv = msgDiv.querySelector('.message-div');  // Assuming structure
          if (contentDiv) contentDiv.innerText = data.message;
        }
      }

  };

  function deleteMessage(msgId) {
    socket.send(JSON.stringify({
      message_type: "delete",
      id: msgId
    }));
  }

  function editMessage(msgId, oldMessage) {
    const newMessage = prompt("Edit your message:", oldMessage);
    if (newMessage && newMessage.trim() !== '') {
      socket.send(JSON.stringify({
        message_type: "edit",
        id: msgId,
        message: newMessage
      }));
    }
  }
</script>

{% endblock  %}